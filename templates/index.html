<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üçïKanban Pizza</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Background and overall look */
    body {
      background: #f8f9fa;
      background-image: url('https://images.stockcake.com/public/c/d/d/cddfa010-3376-4bb4-85fa-c569bcc75915/chef-preparing-pizza-stockcake.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: #333;
    }
    .game-container {
      background-color: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    header {
      border-bottom: 2px solid #dee2e6;
      margin-bottom: 20px;
    }
    .timer, .oven-timer {
      font-size: 1.5rem;
    }
    .btn-custom {
      margin: 5px;
    }
    /* Layout for pizza builder area */
    #pizza-builder {
      border: 2px dashed #ced4da;
      min-height: 150px;
      padding: 10px;
      background-color: #fff;
      border-radius: 4px;
    }
    .ingredient, .builder-item {
      margin: 5px;
      cursor: pointer;
    }
    .ingredient {
      width: 60px;
      height: 60px;
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      font-size: 1.5rem;
    }
    .pizza-item {
      border: 1px solid #adb5bd;
      border-radius: 4px;
      padding: 5px;
      margin-bottom: 5px;
    }
    /* Custom modal styling if needed */
    .modal-content {
      border-radius: 8px;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container game-container">
    <header class="d-flex justify-content-between align-items-center">
      <h1 class="h3">üçï Adam's Kanban Pizza Shop</h1>
      <div>
        <span id="timer" class="timer me-3">Round Time: --</span>
        <span id="oven-timer" class="oven-timer">Oven Time: --</span>
      </div>
    </header>
    <nav class="mb-3">
      <button id="start-round" class="btn btn-primary btn-custom">Start Round</button>
      <button id="oven-on" class="btn btn-success btn-custom">Turn Oven On</button>
      <button id="oven-off" class="btn btn-danger btn-custom">Turn Oven Off</button>
      <button id="instructions-btn" class="btn btn-secondary btn-custom">Instructions</button>
    </nav>
    <main>
      <div id="game-area" class="mb-3" style="display: none;">
        <div class="row">
          <div class="col-md-6">
            <h2>Prepare Ingredients</h2>
            <div id="prepare-buttons" class="mb-3">
              <button onclick="prepareIngredient('base')" class="btn btn-outline-primary btn-custom">Make Base</button>
              <button onclick="prepareIngredient('sauce')" class="btn btn-outline-info btn-custom">Pour Sauce</button>
              <button onclick="prepareIngredient('ham')" class="btn btn-outline-danger btn-custom">Chop Ham</button>
              <button onclick="prepareIngredient('pineapple')" class="btn btn-outline-warning btn-custom">Chop Pineapple</button>
            </div>
            <h4>Shared Ingredients</h4>
            <div id="prepared-pool" class="d-flex flex-wrap border p-2 mb-3" style="min-height: 100px;"></div>
            <h4>Your Pizza Builder</h4>
            <div id="pizza-builder" ondrop="dropToBuilder(event)" ondragover="allowDrop(event)" class="d-flex flex-wrap border p-2 mb-3"></div>
            <button id="submit-pizza" class="btn btn-primary btn-custom">Submit Pizza</button>
          </div>
          <div class="col-md-6">
            <h2>Pizza Status</h2>
            <div class="mb-2">
              <h5>Built Pizzas</h5>
              <div id="built-pizzas" style="min-height: 5vh;border: solid #cccccc;"></div>
            </div>
            <div class="mb-2">
              <h5>Oven</h5>
              <div id="oven" style="min-height: 5vh;border: solid #cccccc;"></div>
            </div>
            <div class="mb-2">
              <h5>Completed Pizzas</h5>
              <div id="completed" style="min-height: 5vh;border: solid #cccccc;"></div>
            </div>
            <div class="mb-2">
              <h5>Wasted Pizzas</h5>
              <div id="wasted" style="min-height: 5vh;border: solid #cccccc;"></div>
            </div>
          </div>
        </div>
        <div id="messages" class="mt-3"></div>
      </div>
    </main>
  </div>

  <!-- Modal for Instructions using Bootstrap modal structure -->
  <div class="modal" tabindex="-1" id="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">How to Play</h5>
          <button type="button" class="btn-close" id="modal-close" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Objective:</strong> Build and bake pizzas to score points.</p>
          <p><strong>Scoring:</strong></p>
          <ul>
            <li>+10 points for each fully cooked pizza slice</li>
            <li>-10 points for each wasted pizza</li>
            <li>-1 point for each leftover ingredient</li>
          </ul>
          <p><strong>Pizza Building:</strong></p>
          <p>To build a valid pizza, you must use:</p>
          <ul>
            <li>1 Base (Dough)</li>
            <li>1 Sauce</li>
            <li>Either 4 Ham pieces <em>or</em> 2 Ham pieces and 2 Pineapple pieces</li>
          </ul>
          <p>Drag the prepared ingredients into your pizza builder and submit your pizza.</p>
          <p><strong>Cooking Instructions:</strong></p>
          <ul>
            <li>If a pizza cooks for less than 30 seconds, it is undercooked and will be wasted.</li>
            <li>If it cooks between 30 and 45 seconds, it is perfectly cooked and will score points.</li>
            <li>If it cooks for more than 45 seconds, it will be burnt and wasted.</li>
          </ul>
          <p><strong>Gameplay:</strong></p>
          <ol>
            <li>Click "Start Round" to begin.</li>
            <li>Prepare ingredients using the provided buttons.</li>
            <li>Drag ingredients into your pizza builder and submit your pizza.</li>
            <li>Move built pizzas to the oven and control the oven (turn on/off) to cook pizzas correctly.</li>
            <li>At the round's end, you'll see a debrief with your team's score.</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Debrief Modal -->
  <div class="modal fade" id="debriefModal" tabindex="-1" aria-labelledby="debriefModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title" id="debriefModalLabel">End of Round Summary</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="debriefModalBody">
          <p><strong>Pizzas Completed:</strong> <span id="debrief-pizzas-completed">0</span></p>
          <p><strong>Pizzas Wasted:</strong> <span id="debrief-pizzas-wasted">0</span></p>
          <p><strong>Leftover Ingredients:</strong> <span id="debrief-ingredients-left">0</span></p>
          <p><strong>Score:</strong> <span id="debrief-score">0</span></p>
          <hr>
          <p>
            <em class="text-muted">
              In this round, did work pile up at any stage? How could you manage it better?
            </em>
          </p>
          <p>
            <em class="text-muted">
              In this round, did visualizing your work help you spot any bottlenecks?
            </em>
          </p>
           <p>
            <em class="text-muted">
               ‚ÄúStop starting and start finishing.‚Äù - David J. Anderson
            </em>
          </p>
           <p>
            <em class="text-muted">
               What do you think David meant by this?
            </em>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts: Bootstrap and Socket.IO from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    var socket = io();
    var myRoom = "";
    var builderIngredients = [];
    var timerInterval = null;
    var ovenTimerInterval = null;
    // clockOffset is computed as: (server time) - (client local time in seconds)
    var clockOffset = 0;

    // Ingredient emoji mapping
    var ingredientEmoji = {
      "base": "üü°",
      "sauce": "üçÖ",
      "ham": "ü•ì",
      "pineapple": "üçç"
    };

    // Modal functionality using Bootstrap
    var modalEl = document.getElementById("modal");
    var modal = new bootstrap.Modal(modalEl);
    document.getElementById("instructions-btn").addEventListener("click", function() {
      modal.show();
    });
    document.getElementById("modal-close").addEventListener("click", function() {
      modal.hide();
    });

    // Listen for sync events to update clockOffset
    socket.on('sync', function(data) {
      var serverTime = data.server_time; // in seconds
      var clientTime = Date.now() / 1000;
      clockOffset = serverTime - clientTime;
    });

    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) {
      ev.dataTransfer.setData("ingredient_id", ev.target.getAttribute("data-id"));
      ev.dataTransfer.setData("ingredient_type", ev.target.dataset.type);
    }
    function dropFromPool(ev) { ev.preventDefault(); }
    function dropToBuilder(ev) {
      ev.preventDefault();
      var ingredient_id = ev.dataTransfer.getData("ingredient_id");
      var ingredient_type = ev.dataTransfer.getData("ingredient_type");
      socket.emit('take_ingredient', { ingredient_id: ingredient_id });
      builderIngredients.push({ id: ingredient_id, type: ingredient_type });
      updateBuilderDisplay();
    }
    function updateBuilderDisplay() {
      var builderDiv = document.getElementById("pizza-builder");
      builderDiv.innerHTML = "";
      builderIngredients.forEach(function(ing) {
        var item = document.createElement("div");
        item.classList.add("builder-item", "ingredient");
        item.innerText = ingredientEmoji[ing.type] || ing.type;
        builderDiv.appendChild(item);
      });
    }
    function prepareIngredient(type) {
      socket.emit('prepare_ingredient', { ingredient_type: type });
    }
    document.getElementById("submit-pizza").addEventListener("click", function() {
      if (builderIngredients.length === 0) {
        alert("No ingredients selected for pizza!");
        return;
      }
      socket.emit('build_pizza', { ingredients: builderIngredients });
      builderIngredients = [];
      updateBuilderDisplay();
    });

    // Updated startRoundTimer uses server time via clockOffset.
    function startRoundTimer(roundStartTime, duration) {
      var roundEndTime = roundStartTime + duration;
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(function() {
        var currentServerTime = Date.now()/1000 + clockOffset;
        var remaining = Math.max(0, Math.floor(roundEndTime - currentServerTime));
        document.getElementById("timer").innerText = "Round Time remaining: " + remaining + " sec";
        if (remaining <= 0) { clearInterval(timerInterval); }
      }, 1000);
    }

    // Updated startOvenTimer uses server time
    function startOvenTimer() {
      var currentServerTime = Date.now()/1000 + clockOffset;
      window.ovenTimerStart = currentServerTime;
      if (ovenTimerInterval) clearInterval(ovenTimerInterval);
      ovenTimerInterval = setInterval(function() {
        var now = Date.now()/1000 + clockOffset;
        var elapsed = Math.floor(now - window.ovenTimerStart);
        document.getElementById("oven-timer").innerText = "Oven Time: " + elapsed + " sec";
      }, 1000);
    }
    function stopOvenTimer() {
      clearInterval(ovenTimerInterval);
      document.getElementById("oven-timer").innerText = "Oven Time: 0 sec";
    }

    socket.on('connect', function() {
      myRoom = prompt("Enter your room number:") || "default";
      socket.emit('join', { room: myRoom });
    });

    socket.on('game_state', function(state) {
      if (state.current_phase === "round") {
        document.getElementById("game-area").style.display = "block";
        document.getElementById("start-round").style.display = "none";
        if (state.round_start_time && state.round_duration) {
          startRoundTimer(state.round_start_time, state.round_duration);
        }
      } else if (state.current_phase === "waiting") {
        document.getElementById("game-area").style.display = "none";
        document.getElementById("timer").innerText = "Round Time remaining: --";
        document.getElementById("start-round").style.display = "inline-block";
      }

      if (state.oven_on && state.oven_timer_start) {
        var currentServerTime = Date.now()/1000 + clockOffset;
        var ovenElapsed = Math.floor(currentServerTime - state.oven_timer_start);
        document.getElementById("oven-timer").innerText = "Oven Time: " + ovenElapsed + " sec";
        if (ovenTimerInterval) clearInterval(ovenTimerInterval);
        ovenTimerInterval = setInterval(function() {
          var now = Date.now()/1000 + clockOffset;
          var elapsed = Math.floor(now - state.oven_timer_start);
          document.getElementById("oven-timer").innerText = "Oven Time: " + elapsed + " sec";
        }, 1000);
      }

      var poolDiv = document.getElementById("prepared-pool");
      poolDiv.innerHTML = "";
      state.prepared_ingredients.forEach(function(item) {
        var div = document.createElement("div");
        div.classList.add("prepared-item", "ingredient");
        div.setAttribute("draggable", "true");
        div.setAttribute("data-id", item.id);
        div.dataset.type = item.type;
        div.innerText = ingredientEmoji[item.type] || item.type;
        div.addEventListener("dragstart", drag);
        poolDiv.appendChild(div);
      });
      var builtDiv = document.getElementById("built-pizzas");
      builtDiv.innerHTML = "";
      state.built_pizzas.forEach(function(pizza) {
        var div = document.createElement("div");
        div.className = "pizza-item";
        div.innerText = "Pizza " + pizza.pizza_id;
        var btn = document.createElement("button");
        btn.className = "btn btn-sm btn-outline-primary";
        btn.innerText = "Move to Oven";
        btn.onclick = function() {
          socket.emit('move_to_oven', { pizza_id: pizza.pizza_id });
        };
        div.appendChild(btn);
        builtDiv.appendChild(div);
      });
      var ovenDiv = document.getElementById("oven");
      ovenDiv.innerHTML = "";
      state.oven.forEach(function(pizza) {
        var div = document.createElement("div");
        div.className = "pizza-item";
        div.innerText = "Pizza " + pizza.pizza_id + " (baking)";
        ovenDiv.appendChild(div);
      });
      var compDiv = document.getElementById("completed");
      compDiv.innerHTML = "";
      state.completed_pizzas.forEach(function(pizza) {
        var div = document.createElement("div");
        div.className = "pizza-item";
        div.innerText = "Pizza " + pizza.pizza_id + " completed";
        compDiv.appendChild(div);
      });
      var wastedDiv = document.getElementById("wasted");
      wastedDiv.innerHTML = "";
      state.wasted_pizzas.forEach(function(pizza) {
        var div = document.createElement("div");
        div.className = "pizza-item";
        div.innerText = "Pizza " + pizza.pizza_id + " " + pizza.status;
        wastedDiv.appendChild(div);
      });
    });

    socket.on('round_started', function(data) {
      document.getElementById("messages").innerText = "Round " + data.round + " started. Duration: " + data.duration + " sec";
      document.getElementById("game-area").style.display = "block";
      document.getElementById("start-round").style.display = "none";
      if (data.start_time && data.duration) {
        startRoundTimer(data.start_time, data.duration);
      } else {
        startRoundTimer(Date.now()/1000 + clockOffset, data.duration);
      }
    });

    // REPLACED the simple alert with Debrief Modal
    socket.on('round_ended', function(result) {
      // Populate modal fields
      document.getElementById("debrief-pizzas-completed").innerText = result.completed_pizzas_count;
      document.getElementById("debrief-pizzas-wasted").innerText = result.wasted_pizzas_count;
      document.getElementById("debrief-ingredients-left").innerText = result.ingredients_left_count || 0;
      document.getElementById("debrief-score").innerText = result.score;

      // Show the Debrief Modal
      var debriefModal = new bootstrap.Modal(document.getElementById('debriefModal'), {});
      debriefModal.show();
    });

    socket.on('game_reset', function(state) {
      document.getElementById("messages").innerText = "Round reset. Ready for a new round.";
      document.getElementById("timer").innerText = "Round Time remaining: --";
      document.getElementById("start-round").style.display = "inline-block";

      // Optionally hide the Debrief Modal if still open
      var debriefModalEl = document.getElementById('debriefModal');
      var modalInstance = bootstrap.Modal.getInstance(debriefModalEl);
      if (modalInstance) {
        modalInstance.hide();
      }
    });

    socket.on('ingredient_prepared', function(item) {
      document.getElementById("messages").innerText = "Ingredient prepared: " + (ingredientEmoji[item.type] || item.type);
    });
    socket.on('build_error', function(data) {
      document.getElementById("messages").innerText = "Build Error: " + data.message;
    });
    socket.on('pizza_built', function(pizza) {
      document.getElementById("messages").innerText = "Pizza built: " + pizza.pizza_id;
    });
    socket.on('oven_error', function(data) {
      document.getElementById("messages").innerText = "Oven Error: " + data.message;
    });
    socket.on('pizza_moved_to_oven', function(pizza) {
      document.getElementById("messages").innerText = "Pizza moved to oven: " + pizza.pizza_id;
    });
    socket.on('oven_toggled', function(data) {
      if (data.state === "on") {
        startOvenTimer();
        document.getElementById("messages").innerText = "Oven turned ON.";
      } else if (data.state === "off") {
        stopOvenTimer();
        document.getElementById("messages").innerText = "Oven turned OFF.";
      }
    });
    document.getElementById("oven-on").addEventListener("click", function() {
      socket.emit('toggle_oven', { state: "on" });
    });
    document.getElementById("oven-off").addEventListener("click", function() {
      socket.emit('toggle_oven', { state: "off" });
    });
    document.getElementById("start-round").addEventListener("click", function() {
      socket.emit('start_round', {});
    });
    window.addEventListener("beforeunload", function () {
      socket.disconnect();
    });
  </script>
</body>
</html>
